# Docs for the Azure Web Apps Deploy action: https://github.com/Azure/webapps-deploy
# More GitHub Actions for Azure: https://github.com/Azure/actions

name: Download and deploy ASP app to Azure Web App - demo4selvan

on:
  #push:
  #  branches:
  #    - main
  workflow_dispatch:
    inputs:
      artifactid:
        required: true
        type: string
        default: '100'

jobs:

  deploy:
    runs-on: linux-latest
    environment:
      name: 'Production'
      url: ${{ steps.deploy-to-webapp.outputs.webapp-url }}
    permissions:
      id-token: write #This is required for requesting the JWT

    steps:

    - name: Call GH API
      run: |
         res = $(curl --location 'https://api.github.com/repos/selvan123/app-service-web-dotnet-get-started/actions/artifacts')
         echo $res
         
    - name: 'Download artifact'
      uses: actions/github-script@v6
      with:
          script: |
            let allArtifacts = await github.rest.actions.listWorkflowRunArtifacts({
               owner: context.repo.owner,
               repo: context.repo.repo,
               run_id: context.payload.workflow_run.id,
            });
            
            let matchArtifact = allArtifacts.data.artifacts.filter((artifact) => {
              return artifact.name == "${{ inputs.artifactid }}"
            })[0];
            
            let download = await github.rest.actions.downloadArtifact({
               owner: context.repo.owner,
               repo: context.repo.repo,
               artifact_id: matchArtifact.id,
               archive_format: 'zip',
            });
            
            let fs = require('fs');
            fs.writeFileSync(`${process.env.GITHUB_WORKSPACE}/${{ inputs.artifactid }}.zip`, Buffer.from(download.data));
            
      
